<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kuitansi Digital - MGMP Matematika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Dancing+Script:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .receipt-card { width: 800px; background: white; padding: 40px; border: 2px solid #e5e7eb; position: relative; overflow: hidden; }
        .editable-id { border-bottom: 1px dashed #ccc; padding: 0 4px; cursor: text; }
        .editable-id:hover { background-color: #f9fafb; }
        .signature-img { 
            mix-blend-mode: multiply; 
            filter: contrast(120%) brightness(110%);
        }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="mb-8 text-center no-print">
            <h1 class="text-3xl font-bold text-blue-700">Manajemen Kuitansi</h1>
            <p class="text-gray-600 font-semibold text-lg">MGMP Matematika SMP Komda Majenang</p>
        </header>

        <nav class="flex space-x-4 mb-8 justify-center no-print">
            <button onclick="switchTab('input')" id="tab-input" class="px-6 py-2 rounded-full bg-blue-600 text-white font-semibold shadow-md transition-all">Kirim Data</button>
            <button onclick="switchTab('cetak')" id="tab-cetak" class="px-6 py-2 rounded-full bg-white text-blue-600 font-semibold shadow-md transition-all">Cetak Kuitansi</button>
        </nav>

        <div id="section-input" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-800">Input Data Baru</h2>
            <form id="kuitansiForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                        <input type="text" id="penerima" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Jumlah Uang (Rp)</label>
                        <input type="number" id="jumlah" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tanggal Pembayaran</label>
                        <input type="date" id="tgl_bayar" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Untuk Keperluan</label>
                    <textarea id="keperluan" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500 outline-none" rows="3"></textarea>
                </div>
                <button type="submit" id="btnSimpan" class="w-full bg-green-600 text-white py-3 rounded-md font-bold hover:bg-green-700 transition shadow-md">SIMPAN KE GOOGLE SHEETS</button>
            </form>
        </div>

        <div id="section-cetak" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-lg no-print">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-semibold text-gray-800">Daftar Data Tersedia</h2>
                    <button onclick="fetchData()" class="bg-blue-50 text-blue-600 px-4 py-1 rounded-md text-sm font-semibold border border-blue-200 hover:bg-blue-100 transition">Segarkan Data</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider text-center">Tgl Bayar</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Nama Sekolah</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Jumlah</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="previewContainer" class="hidden flex flex-col items-center mt-10">
                <div id="receiptUI" class="receipt-card shadow-2xl">
                    <div class="flex justify-between items-start border-b-4 border-blue-800 pb-4 mb-6">
                        <div>
                            <h3 class="text-xl font-black text-blue-800 italic tracking-tighter">KUITANSI</h3>
                            <p class="text-lg text-gray-700 font-mono font-bold mt-1">
                                No: <span id="resID" contenteditable="true" class="editable-id">000</span><span id="resIDSuffix"></span>
                            </p>
                        </div>
                        <div class="text-right">
                            <h4 class="font-bold text-lg text-blue-900 uppercase leading-tight">
                                MGMP MATEMATIKA SMP<br>
                                KOMDA MAJENANG
                            </h4>
                        </div>
                    </div>

                    <div class="space-y-6 text-sm">
                        <div class="flex items-center">
                            <span class="w-44 font-semibold italic text-gray-700">Sudah terima dari</span>
                            <span class="flex-1 border-b border-dotted border-gray-400 pb-1 text-base font-medium" id="resPenerima">...</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-44 font-semibold italic text-gray-700">Banyaknya uang</span>
                            <span class="flex-1 bg-gray-50 p-2 font-bold text-blue-900 italic border border-gray-200" id="resTerbilang">...</span>
                        </div>
                        <div class="flex items-start">
                            <span class="w-44 font-semibold italic text-gray-700 mt-1">Untuk pembayaran</span>
                            <span class="flex-1 border-b border-dotted border-gray-400 pb-1 text-base leading-relaxed" id="resKeperluan">...</span>
                        </div>
                    </div>

                    <div class="mt-14 flex justify-between items-end">
                        <div class="border-2 border-blue-800 px-6 py-3 text-lg font-bold italic text-blue-900">
                            Terbilang : <span id="resJumlah">Rp0,00</span>
                        </div>
                        <div class="text-center w-64 relative">
                            <p class="mb-2 text-sm font-medium" id="resTanggal">Majenang, ...</p>
                            <div class="h-24 flex items-center justify-center relative">
                                <img src="https://lh3.googleusercontent.com/d/1mYKe5jRLdGWGDda0jdD4BhxbcsBzBaKA" 
                                     class="absolute h-20 w-auto object-contain z-10 scale-110 signature-img" 
                                     alt="Tanda Tangan" 
                                     crossorigin="anonymous">
                            </div>
                            <div class="border-t border-black w-full pt-1 font-bold text-gray-900">Belynda Surya Febrinasari</div>
                            <p class="text-xs text-gray-500 tracking-widest font-semibold">Bendahara</p>
                        </div>
                    </div>
                </div>
                <button onclick="downloadPDF()" class="mt-6 mb-10 bg-red-600 text-white px-10 py-4 rounded-lg font-bold shadow-lg hover:bg-red-700 transition-all no-print">
                    UNDUH SEBAGAI PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzAlqjFVCcdXu_xa0Z9MhMqRkS7gdBbvnfqHGIu3f9jyZWoAdm19YJlX7GYlwRmGj5L/exec";

        function formatRupiah(angka) {
            const num = parseFloat(angka) || 0;
            return "Rp" + new Intl.NumberFormat('id-ID', { minimumFractionDigits: 2 }).format(num);
        }

        function formatTanggalIndo(dateStr) {
            if (!dateStr || dateStr === "-") return "-";
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            } catch (e) { return dateStr; }
        }

        function switchTab(tab) {
            document.getElementById('section-input').classList.toggle('hidden', tab !== 'input');
            document.getElementById('section-cetak').classList.toggle('hidden', tab !== 'cetak');
            const btnInput = document.getElementById('tab-input');
            const btnCetak = document.getElementById('tab-cetak');
            if (tab === 'input') {
                btnInput.className = 'px-6 py-2 rounded-full bg-blue-600 text-white font-semibold shadow-md';
                btnCetak.className = 'px-6 py-2 rounded-full bg-white text-blue-600 font-semibold shadow-md';
            } else {
                btnInput.className = 'px-6 py-2 rounded-full bg-white text-blue-600 font-semibold shadow-md';
                btnCetak.className = 'px-6 py-2 rounded-full bg-blue-600 text-white font-semibold shadow-md';
                fetchData();
            }
        }

        document.getElementById('kuitansiForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSimpan');
            btn.disabled = true;
            btn.innerText = "MENGIRIM...";
            
            const data = {
                tgl_bayar: document.getElementById('tgl_bayar').value, 
                penerima: document.getElementById('penerima').value,
                jumlah: document.getElementById('jumlah').value,
                keperluan: document.getElementById('keperluan').value
            };

            try {
                await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify(data)
                });
                alert("Data berhasil dikirim! Silakan periksa Google Sheets Anda.");
                document.getElementById('kuitansiForm').reset();
            } catch (error) { 
                alert("Proses selesai. Silakan cek Google Sheets."); 
            } finally { 
                btn.disabled = false; 
                btn.innerText = "SIMPAN KE GOOGLE SHEETS"; 
            }
        });

        async function fetchData() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Memuat data terbaru...</td></tr>';
            try {
                const response = await fetch(API_URL + "?t=" + new Date().getTime());
                const result = await response.json();
                tableBody.innerHTML = '';
                
                result.data.slice(1).forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-3 font-mono text-sm">${row[0] || '-'}</td>
                        <td class="px-4 py-3 text-center text-sm font-bold text-blue-600">${formatTanggalIndo(row[1])}</td>
                        <td class="px-4 py-3 font-semibold text-sm">${row[2] || '-'}</td>
                        <td class="px-4 py-3 text-green-700 font-bold text-sm">${formatRupiah(row[3])}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick='viewReceipt(${JSON.stringify(row)})' class="bg-blue-600 text-white px-4 py-1 rounded-md text-xs font-bold shadow hover:bg-blue-700 transition">PRATINJAU</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (error) { 
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Gagal memuat data.</td></tr>'; 
            }
        }

        function viewReceipt(row) {
            document.getElementById('previewContainer').classList.remove('hidden');
            
            // Logika penambahan 0 di depan ID (Padding)
            let idRaw = row[0] ? row[0].toString() : "0";
            let paddedID = idRaw.padStart(3, '0');
            document.getElementById('resID').innerText = paddedID;
            
            // Logika penambahan bulan dan tahun di belakang ID
            const date = new Date(row[1]);
            if (!isNaN(date.getTime())) {
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                document.getElementById('resIDSuffix').innerText = `/${month}/${year}`;
            } else {
                document.getElementById('resIDSuffix').innerText = "";
            }

            document.getElementById('resPenerima').innerText = row[2] || "-";
            document.getElementById('resKeperluan').innerText = row[4] || "-";
            document.getElementById('resJumlah').innerText = formatRupiah(row[3]);
            
            let teksTerbilang = terbilang(row[3]) + " rupiah";
            teksTerbilang = teksTerbilang.charAt(0).toUpperCase() + teksTerbilang.slice(1).toLowerCase();
            document.getElementById('resTerbilang').innerText = teksTerbilang;
            document.getElementById('resTanggal').innerText = `Majenang, ${formatTanggalIndo(row[1])}`;
            
            document.getElementById('previewContainer').scrollIntoView({ behavior: 'smooth' });
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('receiptUI');
            const canvas = await html2canvas(element, { scale: 3, useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('l', 'mm', 'a4');
            pdf.addImage(imgData, 'PNG', 0, 15, 297, (canvas.height * 297) / canvas.width);
            pdf.save(`Kuitansi_${document.getElementById('resID').innerText.replace(/\//g, '_')}.pdf`);
        }

        function terbilang(n) {
            const b = ["", "satu", "dua", "tiga", "empat", "lima", "enam", "tujuh", "delapan", "sembilan", "sepuluh", "sebelas"];
            n = parseInt(n);
            if (isNaN(n)) return "";
            let hasil = "";
            if (n < 12) hasil = b[n];
            else if (n < 20) hasil = terbilang(n - 10) + " belas";
            else if (n < 100) hasil = terbilang(Math.floor(n / 10)) + " puluh " + terbilang(n % 10);
            else if (n < 200) hasil = "seratus " + terbilang(n - 100);
            else if (n < 1000) hasil = terbilang(Math.floor(n / 100)) + " ratus " + terbilang(n % 100);
            else if (n < 2000) hasil = "seribu " + terbilang(n - 1000);
            else if (n < 1000000) hasil = terbilang(Math.floor(n / 1000)) + " ribu " + terbilang(n % 1000);
            else if (n < 1000000000) hasil = terbilang(Math.floor(n / 1000000)) + " juta " + terbilang(n % 1000000);
            return hasil.trim();
        }
    </script>
</body>
</html>
