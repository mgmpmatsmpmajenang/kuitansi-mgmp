<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kuitansi Digital - MGMP Matematika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Dancing+Script:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .receipt-card { width: 800px; background: white; padding: 40px; border: 2px solid #e5e7eb; position: relative; overflow: hidden; }
        .editable-id { border-bottom: 1px dashed #ccc; padding: 0 4px; cursor: text; }
        .editable-id:hover { background-color: #f9fafb; }
        .signature-font { font-family: 'Dancing Script', cursive; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Header Halaman -->
        <header class="mb-8 text-center no-print">
            <h1 class="text-3xl font-bold text-blue-700">Manajemen Kuitansi</h1>
            <p class="text-gray-600 font-semibold text-lg">MGMP Matematika SMP Komda Majenang</p>
        </header>

        <!-- Navigasi -->
        <nav class="flex space-x-4 mb-8 justify-center no-print">
            <button onclick="switchTab('input')" id="tab-input" class="px-6 py-2 rounded-full bg-blue-600 text-white font-semibold shadow-md transition-all">Kirim Data</button>
            <button onclick="switchTab('cetak')" id="tab-cetak" class="px-6 py-2 rounded-full bg-white text-blue-600 font-semibold shadow-md transition-all">Cetak Kuitansi</button>
        </nav>

        <!-- Form Input -->
        <div id="section-input" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-gray-800">Input Data Baru</h2>
            <form id="kuitansiForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nama Penerima / Perusahaan</label>
                        <input type="text" id="penerima" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Jumlah Uang (Rp)</label>
                        <input type="number" id="jumlah" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Untuk Keperluan</label>
                    <textarea id="keperluan" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500 outline-none" rows="3"></textarea>
                </div>
                <button type="submit" id="btnSimpan" class="w-full bg-green-600 text-white py-3 rounded-md font-bold hover:bg-green-700 transition shadow-md">SIMPAN KE GOOGLE SHEETS</button>
            </form>
        </div>

        <!-- Section Cetak -->
        <div id="section-cetak" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-lg no-print">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-semibold text-gray-800">Daftar Data Tersedia</h2>
                    <button onclick="fetchData()" class="bg-blue-50 text-blue-600 px-4 py-1 rounded-md text-sm font-semibold border border-blue-200 hover:bg-blue-100 transition">Segarkan Data</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider text-center">Tgl Input</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Penerima</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Jumlah</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data dari sheet akan muncul di sini -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Preview Kuitansi -->
            <div id="previewContainer" class="hidden flex flex-col items-center mt-10">
                <p class="mb-2 text-xs text-gray-400 no-print italic">* Klik pada nomor kuitansi untuk mengubahnya secara manual</p>
                <div id="receiptUI" class="receipt-card shadow-2xl">
                    <div class="flex justify-between items-start border-b-4 border-blue-800 pb-4 mb-6">
                        <div>
                            <h3 class="text-xl font-black text-blue-800 italic tracking-tighter">KUITANSI</h3>
                            <p class="text-lg text-gray-700 font-mono font-bold mt-1">No: <span id="resID" contenteditable="true" class="editable-id" title="Klik untuk edit nomor">0000</span></p>
                        </div>
                        <div class="text-right">
                            <h4 class="font-bold text-lg text-blue-900 uppercase leading-tight">
                                MGMP MATEMATIKA SMP<br>
                                KOMDA MAJENANG
                            </h4>
                        </div>
                    </div>

                    <div class="space-y-6 text-sm">
                        <div class="flex items-center">
                            <span class="w-44 font-semibold italic text-gray-700">Sudah terima dari</span>
                            <span class="flex-1 border-b border-dotted border-gray-400 pb-1 text-base font-medium" id="resPenerima">...</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-44 font-semibold italic text-gray-700">Banyaknya uang</span>
                            <span class="flex-1 bg-gray-50 p-2 font-bold text-blue-900 italic border border-gray-200" id="resTerbilang">...</span>
                        </div>
                        <div class="flex items-start">
                            <span class="w-44 font-semibold italic text-gray-700 mt-1">Untuk pembayaran</span>
                            <span class="flex-1 border-b border-dotted border-gray-400 pb-1 text-base leading-relaxed" id="resKeperluan">...</span>
                        </div>
                    </div>

                    <div class="mt-14 flex justify-between items-end">
                        <div class="border-2 border-blue-800 px-6 py-3 text-lg font-bold italic text-blue-900">
                            Terbilang : <span id="resJumlah">Rp0,00</span>
                        </div>
                        <div class="text-center w-64 relative">
                            <p class="mb-2 text-sm font-medium" id="resTanggal">Majenang, 01 Jan 2024</p>
                            
                            <!-- Area Tanda Tangan -->
                            <div class="h-24 flex items-center justify-center relative">
                                <!-- Gambar Tanda Tangan dari Link Drive (Menggunakan format direct link) -->
                                <img src="https://lh3.googleusercontent.com/u/0/d/1iUpqdeZ5sxJ6mW2OWmvF-3KKCA5iTksv" class="absolute h-24 w-auto object-contain z-10 scale-125" alt="Tanda Tangan Bendahara" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                
                                <!-- Fallback jika gambar gagal dimuat -->
                                <span class="signature-font text-4xl text-blue-800 opacity-80 select-none hidden">Belynda S.F.</span>
                            </div>

                            <div class="border-t border-black w-full pt-1 font-bold text-gray-900">Belynda Surya Febrinasari</div>
                            <p class="text-xs text-gray-500 uppercase tracking-widest font-semibold">Bendahara</p>
                        </div>
                    </div>
                    
                    <!-- Watermark -->
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-[0.03] pointer-events-none whitespace-nowrap">
                        <h2 class="text-8xl font-black rotate-[-15deg]">MGMP MATEMATIKA</h2>
                    </div>
                </div>
                <button onclick="downloadPDF()" class="mt-6 mb-10 bg-red-600 text-white px-10 py-4 rounded-lg font-bold shadow-lg hover:bg-red-700 transition-all flex items-center space-x-2 no-print">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>UNDUH SEBAGAI PDF</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Script Utama -->
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzAlqjFVCcdXu_xa0Z9MhMqRkS7gdBbvnfqHGIu3f9jyZWoAdm19YJlX7GYlwRmGj5L/exec";

        function formatRupiah(angka) {
            const num = parseFloat(angka) || 0;
            const format = new Intl.NumberFormat('id-ID', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
            return "Rp" + format;
        }

        function formatTanggalIndo(dateStr) {
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                return date.toLocaleDateString('id-ID', options);
            } catch (e) {
                return dateStr;
            }
        }

        function switchTab(tab) {
            document.getElementById('section-input').classList.toggle('hidden', tab !== 'input');
            document.getElementById('section-cetak').classList.toggle('hidden', tab !== 'cetak');
            const btnInput = document.getElementById('tab-input');
            const btnCetak = document.getElementById('tab-cetak');
            if (tab === 'input') {
                btnInput.className = 'px-6 py-2 rounded-full bg-blue-600 text-white font-semibold shadow-md transition-all';
                btnCetak.className = 'px-6 py-2 rounded-full bg-white text-blue-600 font-semibold shadow-md transition-all';
            } else {
                btnInput.className = 'px-6 py-2 rounded-full bg-white text-blue-600 font-semibold shadow-md transition-all';
                btnCetak.className = 'px-6 py-2 rounded-full bg-blue-600 text-white font-semibold shadow-md transition-all';
                fetchData();
            }
        }

        document.getElementById('kuitansiForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSimpan');
            btn.disabled = true;
            btn.innerText = "MENGIRIM DATA...";
            const data = {
                penerima: document.getElementById('penerima').value,
                jumlah: document.getElementById('jumlah').value,
                keperluan: document.getElementById('keperluan').value
            };
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                alert("Data berhasil dikirim ke Google Sheets!");
                document.getElementById('kuitansiForm').reset();
            } catch (error) {
                console.error(error);
                alert("Gagal mengirim data.");
            } finally {
                btn.disabled = false;
                btn.innerText = "SIMPAN KE GOOGLE SHEETS";
            }
        });

        async function fetchData() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500 italic">Sedang mengambil data dari Google Sheets...</td></tr>';
            try {
                const response = await fetch(API_URL);
                const result = await response.json();
                tableBody.innerHTML = '';
                if (result.data.length <= 1) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Belum ada data kuitansi.</td></tr>';
                    return;
                }
                result.data.forEach((row, index) => {
                    if (index === 0) return; 
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-blue-50 transition";
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-600 font-mono">${row[0]}</td>
                        <td class="px-4 py-3 text-sm text-center text-gray-500">${formatTanggalIndo(row[1])}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-gray-800">${row[2]}</td>
                        <td class="px-4 py-3 text-sm font-bold text-green-700">${formatRupiah(row[3])}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick='viewReceipt(${JSON.stringify(row)})' class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700 transition shadow">PRATINJAU</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500 font-bold">Terjadi kesalahan koneksi database.</td></tr>';
            }
        }

        function viewReceipt(row) {
            document.getElementById('previewContainer').classList.remove('hidden');
            document.getElementById('resID').innerText = row[0];
            document.getElementById('resPenerima').innerText = row[2];
            document.getElementById('resKeperluan').innerText = row[4];
            document.getElementById('resJumlah').innerText = formatRupiah(row[3]);
            document.getElementById('resTerbilang').innerText = terbilang(row[3]) + " Rupiah";
            document.getElementById('resTanggal').innerText = `Majenang, ${formatTanggalIndo(row[1])}`;
            document.getElementById('previewContainer').scrollIntoView({ behavior: 'smooth' });
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('receiptUI');
            const noKuitansi = document.getElementById('resID').innerText;
            
            const canvas = await html2canvas(element, { scale: 3, useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            
            const pdf = new jsPDF('l', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            const yPos = (pdf.internal.pageSize.getHeight() - pdfHeight) / 2;
            
            pdf.addImage(imgData, 'PNG', 0, yPos, pdfWidth, pdfHeight);
            pdf.save(`Kuitansi_MGMP_${noKuitansi}.pdf`);
        }

        function terbilang(nominal) {
            const bilangan = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
            let temp = "";
            let n = parseInt(nominal);
            if (n < 12) {
                temp = " " + bilangan[n];
            } else if (n < 20) {
                temp = terbilang(n - 10) + " Belas";
            } else if (n < 100) {
                temp = terbilang(Math.floor(n / 10)) + " Puluh " + terbilang(n % 10);
            } else if (n < 200) {
                temp = " Seratus " + terbilang(n - 100);
            } else if (n < 1000) {
                temp = terbilang(Math.floor(n / 100)) + " Ratus " + terbilang(n % 100);
            } else if (n < 2000) {
                temp = " Seribu " + terbilang(n - 1000);
            } else if (n < 1000000) {
                temp = terbilang(Math.floor(n / 1000)) + " Ribu " + terbilang(n % 1000);
            } else if (n < 1000000000) {
                temp = terbilang(Math.floor(n / 1000000)) + " Juta " + terbilang(n % 1000000);
            }
            return temp.replace(/\s+/g, ' ').trim();
        }
    </script>
</body>
</html>
